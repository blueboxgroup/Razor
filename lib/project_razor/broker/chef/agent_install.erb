#!/bin/bash

set -u
set -e

function install_chef() {
  
    mkdir -p /etc/chef

    curl -L https://www.opscode.com/chef/install.sh | bash
    
    cat >/etc/chef/client.rb <<EOFCHEFCLIENT

log_level        :info
log_location     STDOUT
chef_server_url  'http://<%= @options[:server] %>:4000'
validation_client_name 'chef-validator' 
EOFCHEFCLIENT

    cat >/etc/chef/validation.pem <<EOFCHEFVALIDATION
<%= @options[:certificate] %>
EOFCHEFVALIDATION

    gem install ohai
    chef-client -S http://<%= @options[:server] %>:4000

}

function insert_custom_attributes() {
    <% if @options[:meta] %> 
    echo Installing custom node attributes
    cat >/etc/chef/razor_node_attributes.json <<EOFNODEATTRIBUTES
<%= @options[:meta] %>
EOFNODEATTRIBUTES
    chef-client -j /etc/chef/razor_node_attributes.json 
    <% end %>

}

function provision_chef() {
    install_chef
    insert_custom_attributes
    echo Chef Success!
 
    exit 0
}


provision_chef
